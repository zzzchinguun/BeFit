//
//  MealVerificationView.swift
//  BeFit
//
//  Created by Chinguun Khongor on 5/8/25.
//

import SwiftUI

struct MealVerificationView: View {
    @StateObject private var viewModel = MealVerificationViewModel()
    @Environment(\.dismiss) private var dismiss
    @AppStorage("isEnglishLanguage") private var isEnglishLanguage = false
    @AppStorage("isDarkMode") private var isDarkMode = false
    
    var body: some View {
        NavigationStack {
            VStack(spacing: 0) {
                // Header section
                headerView
                
                // Content
                Group {
                    if viewModel.isLoading {
                        loadingView
                    } else if viewModel.unverifiedMeals.isEmpty {
                        emptyStateView
                    } else {
                        mealsListView
                    }
                }
            }
            .background(Color(.systemGroupedBackground))
            .navigationTitle(isEnglishLanguage ? "Meal Verification" : "–•–æ–æ–ª –±–∞—Ç–ª–∞—Ö")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .topBarLeading) {
                    Button(isEnglishLanguage ? "Close" : "–•–∞–∞—Ö") {
                        dismiss()
                    }
                }
                
                ToolbarItem(placement: .topBarTrailing) {
                    Button {
                        Task {
                            await viewModel.fetchUnverifiedMeals()
                        }
                    } label: {
                        Image(systemName: "arrow.clockwise")
                    }
                }
            }
            .onAppear {
                Task {
                    await viewModel.fetchUnverifiedMeals()
                }
            }
            .alert(isEnglishLanguage ? "üü¢ APPROVE Meal" : "üü¢ –•–æ–æ–ª –ë–ê–¢–õ–ê–•", isPresented: $viewModel.showingVerificationAlert) {
                Button(isEnglishLanguage ? "Cancel" : "–¶—É—Ü–ª–∞—Ö", role: .cancel) { }
                Button(isEnglishLanguage ? "‚úÖ APPROVE" : "‚úÖ –ë–ê–¢–õ–ê–•") {
                    Task {
                        await viewModel.verifySelectedMeal()
                    }
                }
            } message: {
                if let meal = viewModel.selectedMeal {
                    Text(isEnglishLanguage ? 
                         "Are you sure you want to APPROVE '\(meal.name)'? This will make it available to all users." :
                         "'\(meal.name)' —Ö–æ–æ–ª—ã–≥ –ë–ê–¢–õ–ê–•–î–ê–ê –∏—Ç–≥—ç–ª—Ç—ç–π –±–∞–π–Ω–∞ —É—É? –≠–Ω—ç –Ω—å –±“Ø—Ö —Ö—ç—Ä—ç–≥–ª—ç–≥—á–¥—ç–¥ —Ö–∞—Ä–∞–≥–¥–∞—Ö –±–æ–ª–Ω–æ.")
                }
            }
            .alert(isEnglishLanguage ? "üî¥ REJECT Meal" : "üî¥ –•–æ–æ–ª –¢–ê–¢–ì–ê–õ–ó–ê–•", isPresented: $viewModel.showingRejectionAlert) {
                Button(isEnglishLanguage ? "Cancel" : "–¶—É—Ü–ª–∞—Ö", role: .cancel) { }
                Button(isEnglishLanguage ? "‚ùå REJECT" : "‚ùå –¢–ê–¢–ì–ê–õ–ó–ê–•", role: .destructive) {
                    Task {
                        await viewModel.rejectSelectedMeal()
                    }
                }
            } message: {
                VStack {
                    if let meal = viewModel.selectedMeal {
                        Text(isEnglishLanguage ? 
                             "Are you sure you want to REJECT '\(meal.name)'?" :
                             "'\(meal.name)' —Ö–æ–æ–ª—ã–≥ –¢–ê–¢–ì–ê–õ–ó–ê–•–î–ê–ê –∏—Ç–≥—ç–ª—Ç—ç–π –±–∞–π–Ω–∞ —É—É?")
                    }
                    
                    TextField(isEnglishLanguage ? "Reason (optional)" : "–®–∞–ª—Ç–≥–∞–∞–Ω (–∑–∞–∞–≤–∞–ª –±–∏—à)", 
                             text: $viewModel.rejectionReason)
                }
            }
        }
    }
    
    // MARK: - Header View
    
    private var headerView: some View {
        VStack(spacing: 12) {
            HStack {
                Image(systemName: "checkmark.shield.fill")
                    .font(.title)
                    .foregroundColor(.blue)
                
                VStack(alignment: .leading) {
                    Text(isEnglishLanguage ? "Super Admin" : "–°—É–ø–µ—Ä –∞–¥–º–∏–Ω")
                        .font(.headline)
                        .fontWeight(.bold)
                    
                    Text(isEnglishLanguage ? "Meal Verification Panel" : "–•–æ–æ–ª –±–∞—Ç–ª–∞—Ö —Å–∞–º–±–∞—Ä")
                        .font(.subheadline)
                        .foregroundColor(.secondary)
                }
                
                Spacer()
                
                Text("\(viewModel.unverifiedMeals.count)")
                    .font(.title2)
                    .fontWeight(.bold)
                    .foregroundColor(.blue)
                    .padding(.horizontal, 12)
                    .padding(.vertical, 6)
                    .background(Color.blue.opacity(0.1))
                    .clipShape(Capsule())
            }
            
            Text(isEnglishLanguage ? 
                 "Review and approve user-submitted meals to make them available in the nutrition database." :
                 "–•—ç—Ä—ç–≥–ª—ç–≥—á–¥–∏–π–Ω –∏–ª–≥—ç—ç—Å—ç–Ω —Ö–æ–æ–ª—ã–≥ —à–∞–ª–≥–∞–∂, —Ö–æ–æ–ª–Ω—ã —Å–∞–Ω–¥ –Ω—ç–º—ç—Ö–∏–π–≥ –∑”©–≤—à”©”©—Ä–Ω”© “Ø“Ø.")
                .font(.caption)
                .foregroundColor(.secondary)
                .multilineTextAlignment(.leading)
        }
        .padding()
        .background(Color(.secondarySystemBackground))
    }
    
    // MARK: - Loading View
    
    private var loadingView: some View {
        VStack(spacing: 20) {
            ProgressView()
                .scaleEffect(1.2)
            
            Text(isEnglishLanguage ? "Loading unverified meals..." : "–ë–∞—Ç–ª–∞–≥–¥–∞–∞–≥“Ø–π —Ö–æ–æ–ª—ã–≥ –∞—á–∞–∞–ª–ª–∞–∂ –±–∞–π–Ω–∞...")
                .font(.subheadline)
                .foregroundColor(.secondary)
        }
        .frame(maxWidth: .infinity, maxHeight: .infinity)
    }
    
    // MARK: - Empty State View
    
    private var emptyStateView: some View {
        VStack(spacing: 24) {
            Image(systemName: "checkmark.circle.fill")
                .font(.system(size: 80))
                .foregroundColor(.green)
            
            VStack(spacing: 12) {
                Text(isEnglishLanguage ? "All Caught Up!" : "–ë“Ø–≥–¥ —à–∞–ª–≥–∞–≥–¥–ª–∞–∞!")
                    .font(.title2)
                    .fontWeight(.bold)
                
                Text(isEnglishLanguage ? 
                     "No unverified meals found. All user submissions have been reviewed." :
                     "–ë–∞—Ç–ª–∞–≥–¥–∞–∞–≥“Ø–π —Ö–æ–æ–ª –±–∞–π—Ö–≥“Ø–π. –ë“Ø—Ö —Ö—ç—Ä—ç–≥–ª—ç–≥—á–∏–π–Ω –∏–ª–≥—ç—ç—Å—ç–Ω —Ö–æ–æ–ª —à–∞–ª–≥–∞–≥–¥—Å–∞–Ω –±–∞–π–Ω–∞.")
                    .font(.subheadline)
                    .foregroundColor(.secondary)
                    .multilineTextAlignment(.center)
                    .padding(.horizontal, 32)
            }
        }
        .frame(maxWidth: .infinity, maxHeight: .infinity)
    }
    
    // MARK: - Meals List View
    
    private var mealsListView: some View {
        List {
            ForEach(viewModel.unverifiedMeals) { meal in
                UnverifiedMealRow(
                    meal: meal,
                    onVerify: { viewModel.showVerificationConfirmation(for: meal) },
                    onReject: { viewModel.showRejectionConfirmation(for: meal) }
                )
            }
        }
        .listStyle(InsetGroupedListStyle())
    }
}

// MARK: - Unverified Meal Row

struct UnverifiedMealRow: View {
    let meal: UnverifiedMeal
    let onVerify: () -> Void
    let onReject: () -> Void
    @AppStorage("isEnglishLanguage") private var isEnglishLanguage = false
    
    var body: some View {
        VStack(alignment: .leading, spacing: 12) {
            // Header with meal name and creator
            HStack {
                VStack(alignment: .leading, spacing: 4) {
                    Text(meal.name)
                        .font(.headline)
                        .fontWeight(.semibold)
                    
                    Text(isEnglishLanguage ? 
                         "Created by: \(meal.createdByEmail)" :
                         "“Æ“Ø—Å–≥—ç—Å—ç–Ω: \(meal.createdByEmail)")
                        .font(.caption)
                        .foregroundColor(.secondary)
                }
                
                Spacer()
                
                categoryBadge
            }
            
            // Nutrition info
            HStack(spacing: 16) {
                nutritionItem(
                    icon: "flame.fill",
                    label: isEnglishLanguage ? "Cal" : "–ö–∞–ª",
                    value: "\(meal.calories)",
                    color: .orange
                )
                
                nutritionItem(
                    icon: "p.circle.fill",
                    label: isEnglishLanguage ? "Pro" : "–£—É—Ä–∞–≥",
                    value: "\(meal.protein)g",
                    color: .blue
                )
                
                nutritionItem(
                    icon: "c.circle.fill",
                    label: isEnglishLanguage ? "Carb" : "–ù“Ø“Ø—Ä—Å",
                    value: "\(meal.carbs)g",
                    color: .green
                )
                
                nutritionItem(
                    icon: "f.circle.fill",
                    label: isEnglishLanguage ? "Fat" : "”®”©—Ö",
                    value: "\(meal.fat)g",
                    color: .red
                )
            }
            
            // Serving info if available
            if let servingSize = meal.servingSizeGrams,
               let servingDescription = meal.servingDescription {
                Text(isEnglishLanguage ? 
                     "Serving: \(servingDescription) (\(String(format: "%.0f", servingSize))g)" :
                     "–ü–æ—Ä—Ü: \(servingDescription) (\(String(format: "%.0f", servingSize))–≥)")
                    .font(.caption)
                    .foregroundColor(.secondary)
            }
            
            // Date created
            Text(isEnglishLanguage ? 
                 "Submitted: \(meal.dateCreated.formatted(date: .abbreviated, time: .shortened))" :
                 "–ò–ª–≥—ç—ç—Å—ç–Ω: \(meal.dateCreated.formatted(date: .abbreviated, time: .shortened))")
                .font(.caption)
                .foregroundColor(.secondary)
            
            // Action buttons
            HStack(spacing: 12) {
                Button(action: onVerify) {
                    HStack(spacing: 6) {
                        Image(systemName: "checkmark.circle.fill")
                        Text(isEnglishLanguage ? "Verify" : "–ë–∞—Ç–ª–∞—Ö")
                    }
                    .font(.subheadline)
                    .fontWeight(.semibold)
                    .foregroundColor(.white)
                    .padding(.horizontal, 16)
                    .padding(.vertical, 8)
                    .background(Color.green)
                    .clipShape(Capsule())
                }
                
                Button(action: onReject) {
                    HStack(spacing: 6) {
                        Image(systemName: "xmark.circle.fill")
                        Text(isEnglishLanguage ? "Reject" : "–¢–∞—Ç–≥–∞–ª–∑–∞—Ö")
                    }
                    .font(.subheadline)
                    .fontWeight(.semibold)
                    .foregroundColor(.white)
                    .padding(.horizontal, 16)
                    .padding(.vertical, 8)
                    .background(Color.red)
                    .clipShape(Capsule())
                }
                
                Spacer()
            }
        }
        .padding(.vertical, 8)
    }
    
    private var categoryBadge: some View {
        Text(meal.category.rawValue)
            .font(.caption)
            .fontWeight(.medium)
            .foregroundColor(categoryColor.opacity(0.8))
            .padding(.horizontal, 8)
            .padding(.vertical, 4)
            .background(categoryColor.opacity(0.15))
            .clipShape(Capsule())
    }
    
    private var categoryColor: Color {
        switch meal.category {
        case .meat: return .red
        case .dairy: return .blue
        case .grains: return .orange
        case .fruits: return .pink
        case .vegetables: return .green
        case .nuts: return .brown
        case .beverages: return .cyan
        case .snacks: return .purple
        case .custom: return .gray
        }
    }
    
    private func nutritionItem(icon: String, label: String, value: String, color: Color) -> some View {
        VStack(spacing: 2) {
            Image(systemName: icon)
                .font(.caption)
                .foregroundColor(color)
            
            Text(value)
                .font(.caption)
                .fontWeight(.semibold)
            
            Text(label)
                .font(.caption2)
                .foregroundColor(.secondary)
        }
    }
}

#Preview {
    MealVerificationView()
} 